@using EurovisionOnMars.Dto.PlayerRatings
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText>dra og dropp for å rangere land med plassering @calculatedRank</MudText>
        <MudDropContainer T="PredictionDto"
            Items="SameRankPredictions">
            <MudDropZone>
                
            </MudDropZone>
        </MudDropContainer>
    </DialogContent>
    <DialogActions>
        <MudIconButton Variant="Variant.Filled" Color="Color.Secondary"
                       Icon="@Icons.Material.Filled.Check"
                       OnClick="UpdatePredictions">
        </MudIconButton>
        <MudIconButton Variant="Variant.Filled" Color="Color.Secondary"
                       Icon="@Icons.Material.Filled.Close"
                       OnClick="Cancel">
        </MudIconButton>
    </DialogActions>
</MudDialog>


@code {
    [CascadingParameter] MudDialogInstance Dialog { get; set; }

    [Parameter] public List<PredictionDto> SameRankPredictions { get; set; } = null!;

    private int calculatedRank;
    private int sameRankCount;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        var somePrediciton = SameRankPredictions.FirstOrDefault();
        this.calculatedRank = (int)somePrediciton!.CalculatedRank!;
        this.sameRankCount = (int)somePrediciton!.SameRankCount!;
    }

    private void Cancel()
    {
        Dialog.Cancel();
    }

    private async Task UpdatePredictions()
    {
        foreach (PredictionDto prediciton in SameRankPredictions) {
            await UpdatePrediction(prediciton);
        }
    }

    private async Task UpdatePrediction(PredictionDto prediciton)
    {
        // TODO
        var response = await Http.PatchAsJsonAsync<int>($"/api/PlayerRatings/{Rating.Id}/Rank", calculatedRank);
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("rangering lagret", Severity.Success);
            Console.WriteLine($"Successfully updated rating with id: {Rating!.Id}");
            Dialog.Close();
        }
        else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            Snackbar.Add("stemming er stengt", Severity.Error);
            Console.WriteLine($"Failed to update rating due to: {response.StatusCode}");
        }
        else
        {
            Snackbar.Add("noe gikk galt, prøv igjen", Severity.Error);
            Console.WriteLine($"Failed to update rating due to: {response.StatusCode}");
        }
    }
}