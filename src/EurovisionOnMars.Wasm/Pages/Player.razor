@page "/player/{id:int}"
@using EurovisionOnMars.Wasm.Components
@inject HttpClient Http
@inject IToastService ToastService
@inject IDialogService DialogService

<MudTable 
    T="RatingDto" 
    Items="@Ratings" 
    OnRowClick="HandleSelectRating"
    Breakpoint="Breakpoint.None" 
    Hover=true RowClass="cursor-pointer">
    <HeaderContent>
        <MudTh>#</MudTh>
        <MudTh>land</MudTh>
        <MudTh>plassering</MudTh>
        <MudTh>poengsum</MudTh>
    </HeaderContent>
    <RowTemplate Context="rating">
        <!-- TODO: replace with actual values -->
        <MudTd DataLabel="#">2</MudTd>
        <MudTd DataLabel="land">norge</MudTd>
        <MudTd DataLabel="plassering">10</MudTd>
        <MudTd DataLabel="poengsum">@rating.Category3Points</MudTd>
    </RowTemplate>
</MudTable>

    @code {
    [Parameter] public int Id { get; set; }
    public List<RatingDto> Ratings { get; set; } = new List<RatingDto>();

    protected override async Task OnInitializedAsync()
    {
        var response = await Http.GetAsync($"https://localhost:7195/api/Ratings/{Id}");
        if (response.IsSuccessStatusCode)
        {
            Ratings = await response.Content.ReadFromJsonAsync<List<RatingDto>>();
            Console.WriteLine($"Got ratings for player with id={Id}");
        }
        else
        {
            ToastService.ShowError("noe gikk galt, prøv igjen");
            Console.WriteLine($"Failed to get ratings for player with id={Id}");
        }
    }

    private async void HandleSelectRating(TableRowClickEventArgs<RatingDto> tableRowClickEventArgs)
    {
        var selectedRating = tableRowClickEventArgs.Item;
        var parameters = new DialogParameters<RatingDialog>();
        parameters.Add(x => x.Rating, selectedRating);

        var dialogResponse = await DialogService.ShowAsync<RatingDialog>($"stemmeskjema for {selectedRating.Id}", parameters);
        var dialogResult = await dialogResponse.Result;
        if (!dialogResult.Canceled)
        {
            var updatedRating = await dialogResponse.GetReturnValueAsync<RatingDto>();
            if (updatedRating != null)
            {
                UpdateRatingState(selectedRating, updatedRating);
                StateHasChanged();
            }
        }
    }

    private void UpdateRatingState(RatingDto rating, RatingDto updatedRating)
    {
        rating.Category1Points = updatedRating.Category1Points;
        rating.Category2Points = updatedRating.Category2Points;
        rating.Category3Points = updatedRating.Category3Points;
    }
}